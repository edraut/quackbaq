<h1><%= @auction.item.name %></h1>
<% if current_user %>
	<div class="span-20">
		You have <span id="available_bids"><%= @this_user.bids.available.count %></span> bids available.
	</div>
	<div class="span-20">
		<%= link_to 'place a bid', bid_url(@this_user.bids.first, :placed_auction_id => @auction.id), 
	:id => 'place_bid_link', 
	:style => @this_user.bids.available.any? ? '' : 'display:none;'
 	 %>
		<%= link_to 'buy bids', bids_url, :id => 'buy_bids_link', :style => @this_user.bids.available.empty? ? '' : 'display:none;' %>
	</div>
	<div class="span-20" id="bid_history">
		<h3>Bid History</h3>
	</div>
	<% javascript_tag do %>
		jQuery(document).ready(function(){
			function refreshBidHistory(new_history){
				jQuery('#bid_history').append(new_history.user + ': ' + new_history.payload + '<br/>');
			};
			hookbox.logging.get('net.protocols.rtjp').setLevel(hookbox.logging.DEBUG);
			conn = hookbox.connect("<%= HOOKBOX_URL %>");
			conn.onSubscribed = function(channel_name, subscription) {
				if(channel_name == "<%= @auction.channel_name %>"){
					subscription.onPublish = function(frame) {
						refreshBidHistory(frame);
					};
		  			for (var i = 0, item; item = subscription.history[i]; ++i) {
					  	var name = item[0];
						var frame = item[1];
						if(name == 'PUBLISH'){
							refreshBidHistory(frame);
						}
				    };
				}
			};
			conn.onClose = function() {
				alert("Connection Lost, please refresh this page");
			};
			conn.subscribe("<%= @auction.channel_name %>");
			jQuery('#place_bid_link').click(function(e){
				jQuery.ajax({
					url: jQuery(e.target).attr('href'),
					type: 'PUT',
					dataType: 'json',
					success: function(data,textStatus) {
						jQuery('#available_bids').html(data.bid_count);
						if(data.bid_count == 0){
							jQuery('#place_bid_link').hide();
							jQuery('#buy_bids_link').show();
						}
					}
				});
				return false;
			});
		});
	<% end %>
<% else %>
	<%= link_to 'sign in', sign_in_url %> or <%= link_to 'sign_up', sign_up_url %> to join the auction.
<% end %>